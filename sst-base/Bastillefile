# system
# Needs reboot, so handle in post-install shell
# CMD freebsd-update fetch-install

ARG SYSADMIN_EMAIL="web+rocinante@g.superscript.com"

CMD zfs set atime=off zroot

# ssh
CMD rm /etc/ssh/ssh_host_*
SYSRC sshd_dsa_enable="NO"
SYSRC sshd_ecdsa_enable="NO"
SYSRC sshd_ed25519_enable="YES"
SYSRC sshd_rsa_enable="YES"
SERVICE sshd keygen
SERVICE sshd restart


# packages
PKG sysutils/bastille
SYSRC -f /usr/local/etc/bastille/bastille.conf bastille_zfs_enable="YES"
SYSRC -f /usr/local/etc/bastille/bastille.conf bastille_zfs_zpool="zroot"

# Prohibitively slow:
# CMD bastille bootstrap 14.0-RELEASE update
# CMD bastille bootstrap 13.2-RELEASE update
# CMD bastille bootstrap 13.3-RELEASE update

PKG sysutils/daemontools-encore sysutils/ucspi-ipc sysutils/ucspi-tcp sysutils/htop

PKG devel/git devel/gh devel/gmake

PKG security/gnupg security/pinentry-curses security/sshpass

# microcode updates
PKG sysutils/cpu-microcode sysutils/cpu-microcode-rc
SYSRC  microcode_update_enable="YES"
SERVICE microcode_update start


# network
CMD mkdir -p -m 0700 /etc/wpa_supplicant
CMD test -f /etc/wpa_supplicant/wpa_supplicant.conf || cp /etc/wpa_supplicant.conf /etc/wpa_supplicant/wpa_supplicant.conf
SYSRC wpa_supplicant_conf_file="/etc/wpa_supplicant/wpa_supplicant.conf"
SYSRC cloned_interfaces+=lo1
SYSRC cloned_interfaces+=bridge0
SYSRC ifconfig_bridge0="inet 10.0.0.1/16 addm wlan0 up"
SERVICE netif restart

CP etc /
CP usr /

CMD sysctl -f /etc/sysctl.conf
SYSRC pf_enable="YES"
SYSRC gateway_enable="YES"
SERVICE pf restart


# ssh
CMD mkdir -p -m 0700 /root/.ssh
CMD test -r "/root/.ssh/rocinante@$(hostname).pub" || ssh-keygen -t ed25519 -f "/root/.ssh/rocinante@$(hostname)" -N ''
CMD mail -s "rocinante@$(hostname)" '${SYSADMIN_EMAIL}' < "/root/.ssh/rocinante@$(hostname).pub"
CMD echo mail -s "rocinante@$(hostname)" '${SYSADMIN_EMAIL}' >> /tmp/mail.cmd < "/root/.ssh/rocinante@$(hostname).pub"

# time

SYSRC ntpd_enable="YES"
SYSRC ntpd_sync_on_start="YES"
SERVICE ntpd restart


# other
CMD touch /usr/share/skel/dot.hushlogin
SYSRC sendmail_enable="NONE"
SYSRC powerd_enable="YES"
SYSRC clear_tmp_enable="YES"


