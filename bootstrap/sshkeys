#!/bin/sh

key="/root/.ssh/rocinante@$(hostname -s)"

do_clean() {
  rm -f "${key}" "${key}.pub" "${key}.pw"
}

do_create() {
  do_clean
  mkdir -p -m 0700 /root/.ssh
  touch "${key}.pw"
  chmod 0600 "${key}.pw"
  openssl rand -base64 20 > "${key}.pw"
  openssl genrsa -out "${key}" -passout "file:${key}.pw" 4096
  sshpass -f "${key}.pw" ssh-keygen -y -f "${key}" > "${key}.pub"
  printf '%s\n' "${key}.pub"
}

do_init() {
  test -f "${key}.pub" && printf '%s\n' "${key}.pub" || do_create
}

case "$1" in
  clean|create|init)
    "do_$@"
    exit 0
    ;;

  *)
    echo "unrecognized command: $1"
    exit 100
    ;;
esac

